<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warung R&Z Center</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --primary: #ff4757; --success: #2ed573; --bg: #f1f2f6; --blue: #2196f3; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 350px; }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spin { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .container { padding: 10px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .menu-card { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); }
        .menu-card.sold-out { opacity: 0.5; filter: grayscale(1); }
        .price { color: var(--primary); font-weight: bold; font-size: 12px; margin: 5px 0; display: block; }
        .btn-tambah { width: 100%; background: var(--primary); color: white; border: none; padding: 8px; border-radius: 6px; font-weight: bold; font-size: 11px; }

        /* KOTAK STATUS - PERBAIKAN */
        #status-pesanan { 
            display: none; background: var(--blue); color: white; padding: 15px; 
            border-radius: 15px; margin: 10px; font-size: 13px; position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-close { position: absolute; top: 5px; right: 10px; color: white; font-size: 20px; font-weight: bold; cursor: pointer; }

        .cart-section { position: fixed; bottom: 0; width: 100%; background: white; padding: 12px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); border-radius: 20px 20px 0 0; box-sizing: border-box; z-index: 200; }
        #cart-display { max-height: 50px; overflow-y: auto; font-size: 11px; background: #f9f9f9; padding: 5px; border-radius: 8px; margin-bottom: 5px; border: 1px dashed #ccc; }
        input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 12px; }
        textarea { height: 40px; background: #fff9c4; }
        .btn-order { background: var(--success); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; margin-top: 8px; font-size: 15px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spin"></div><p>Menyambungkan...</p></div>

    <div class="header">
        <h3 style="margin:0">R&Z CENTER <span id="count-view" style="font-size:12px; background:white; color:red; padding:2px 6px; border-radius:10px">30</span></h3>
        <span id="conn-status" style="font-size: 10px;">ðŸŸ¡ Menyambungkan...</span>
    </div>

    <div id="status-pesanan">
        <span class="btn-close" onclick="document.getElementById('status-pesanan').style.display='none'">&times;</span>
        <strong id="status-judul">Menunggu Konfirmasi...</strong><br>
        <span id="status-note">Sedang diproses oleh penjual.</span><br>
        <hr style="border: 0.5px solid rgba(255,255,255,0.3)">
        <div style="display: flex; justify-content: space-between;">
            <span>Belanjaan:</span> <span id="view-belanja">0</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <span>Ongkir:</span> <span id="view-ongkir">0</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 15px; margin-top: 5px; border-top: 1px solid white;">
            <span>TOTAL BAYAR:</span> <span id="view-total">0</span>
        </div>
    </div>

    <div class="container">
        <div class="menu-grid" id="menu-list"></div>
    </div>

    <div class="cart-section">
        <div id="cart-display">Keranjang kosong...</div>
        <textarea id="request" placeholder="Catatan: Rasa Pop Ice/Minuman, Pedas, dll"></textarea>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="nama" placeholder="Nama Anda" style="flex:1">
            <select id="metode" style="flex:1">
                <option value="COD">COD</option>
                <option value="DANA">DANA</option>
            </select>
        </div>
        <input type="text" id="alamat" placeholder="Alamat & Patokan Rumah">
        <button class="btn-order" onclick="gasOrder()">KIRIM PESANAN (<span id="total-cart">0</span>)</button>
    </div>

    <script>
        const ably = new Ably.Realtime('_5uX1A.i3oY3Q:-F3Wm3iLu9vzEUXraD6HVdeHjh_pxk7pEqyzCGwNhsg');
        const channel = ably.channels.get('warung-rz');

        const menus = [
            {id:25, n:"Es Teler Teko", p:25000}, {id:1, n:"Bakso Beranak", p:10000}, {id:2, n:"Bakso Telur", p:10000},
            {id:3, n:"Bakso Keju", p:10000}, {id:4, n:"Mie Bakso", p:10000}, {id:5, n:"Mie Ayam", p:10000},
            {id:6, n:"Soteng", p:10000}, {id:7, n:"Kupat Tahu", p:10000}, {id:8, n:"Siomay", p:10000},
            {id:9, n:"Kebab", p:10000}, {id:10, n:"Lumpia Basah", p:10000}, {id:24, n:"Es Teler Besar", p:10000},
            {id:104, n:"Sosis Bakar Besar", p:5000}, {id:11, n:"Mie Jebew", p:5000}, {id:12, n:"Batagorr", p:5000},
            {id:13, n:"Burger", p:5000}, {id:14, n:"Wonton", p:5000}, {id:23, n:"Es Teler Kecil", p:5000},
            {id:102, n:"Pop Ice (Semua Rasa)", p:5000}, {id:15, n:"Cordog Sosis", p:3000}, {id:16, n:"Cordog Moza", p:3000},
            {id:17, n:"Dimsum Keju", p:2500}, {id:18, n:"Ayam Keju", p:2500}, {id:19, n:"Bola Rambutan", p:2500},
            {id:105, n:"Sate Seafood", p:2000}, {id:106, n:"Sosis Bakar Kecil", p:2000}, {id:20, n:"Dimsum", p:2000},
            {id:21, n:"Lumpia Ayam", p:2000}, {id:22, n:"Sempol", p:2000}, {id:101, n:"Minuman Saset (Tea Jus/Marimas)", p:1000}
        ];

        let soldOuts = [];
        let keranjang = [];
        let lastSentMessageId = null;

        ably.connection.on('connected', () => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('conn-status').innerText = "ðŸŸ¢ CENTER ONLINE";
        });

        // MENERIMA STATUS DARI CENTER KAMU
        channel.subscribe('update-status', (msg) => {
            // Kita cek apakah ID yang dibalas Center sama dengan ID pesan terakhir pembeli
            if(msg.data.id === lastSentMessageId) {
                document.getElementById('status-pesanan').style.display = 'block';
                document.getElementById('status-judul').innerText = "âœ… PESANAN " + msg.data.status;
                document.getElementById('status-note').innerText = "Note Penjual: " + (msg.data.note || "-");
                document.getElementById('view-belanja').innerText = "Rp " + msg.data.total.toLocaleString();
                document.getElementById('view-ongkir').innerText = "Rp " + msg.data.ongkir.toLocaleString();
                document.getElementById('view-total').innerText = "Rp " + (msg.data.total + msg.data.ongkir).toLocaleString();
                
                new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play();
            }
        });

        channel.subscribe('update-stok', (msg) => {
            soldOuts = msg.data.soldOut;
            render();
        });

        function render() {
            const list = document.getElementById('menu-list');
            list.innerHTML = '';
            menus.forEach(m => {
                const isOut = soldOuts.includes(m.id);
                list.innerHTML += `
                    <div class="menu-card ${isOut ? 'sold-out' : ''}">
                        <b>${m.n}</b>
                        <span class="price">Rp ${m.p.toLocaleString()}</span>
                        <button class="btn-tambah" ${isOut ? 'disabled' : ''} onclick="add(${m.id})">
                            ${isOut ? 'HABIS' : '+ TAMBAH'}
                        </button>
                    </div>`;
            });
        }

        function add(id) {
            const item = menus.find(m => m.id === id);
            keranjang.push(item);
            updateUI();
        }

        function updateUI() {
            const disp = document.getElementById('cart-display');
            const totalView = document.getElementById('total-cart');
            let total = 0;
            let names = keranjang.map(i => { total += i.p; return i.n; }).join(", ");
            disp.innerHTML = keranjang.length === 0 ? "Keranjang kosong..." : `<b>Isi:</b> ${names}`;
            totalView.innerText = "Rp " + total.toLocaleString();
        }

        function gasOrder() {
            const nama = document.getElementById('nama').value;
            const alamat = document.getElementById('alamat').value;
            const req = document.getElementById('request').value;
            const met = document.getElementById('metode').value;

            if(keranjang.length === 0 || !nama || !alamat) return alert("Lengkapi data!");

            let totalBelanja = keranjang.reduce((s, i) => s + i.p, 0);
            let detail = keranjang.map(i => i.n).join(", ");

            // PROSES KIRIM PESANAN
            channel.publish('pesanan-baru', {
                nama: nama, metode: met, alamat: alamat,
                detail: `${detail} | Catatan: ${req || '-'}`,
                total: totalBelanja
            }, (err) => {
                // Ably akan memberikan message ID unik otomatis setelah pesan terkirim
            });

            // Kita ambil ID pesan dari Ably supaya sinkron dengan Center
            channel.history((err, resultPage) => {
                lastSentMessageId = resultPage.items[0].id;
            });

            alert("Terkirim! Kotak status akan muncul di atas saat penjual membalas.");
            document.getElementById('status-pesanan').style.display = 'block';
            document.getElementById('status-judul').innerText = "Menunggu Konfirmasi Penjual...";
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
        render();
    </script>
</body>
</html>
